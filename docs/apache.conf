# Apache Configuration for QPAY
# File location: /etc/apache2/sites-available/qpay.yourin.my.id.conf

# HTTP redirect ke HTTPS
<VirtualHost *:80>
    ServerName qpay.yourin.my.id
    ServerAlias www.qpay.yourin.my.id

    # Let's Encrypt certificate validation
    DocumentRoot /var/www/letsencrypt
    <Directory /var/www/letsencrypt>
        Require all granted
    </Directory>

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/ [NC]
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# HTTPS server
<VirtualHost *:443>
    ServerName qpay.yourin.my.id
    ServerAlias www.qpay.yourin.my.id

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/qpay.yourin.my.id/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/qpay.yourin.my.id/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/qpay.yourin.my.id/chain.pem

    # SSL Protocols dan Ciphers
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384'
    SSLHonorCipherOrder on
    SSLCompression off

    # SSL Sessions
    SSLSessionCache shmcb:/var/cache/apache2/ssl_scache(512000)
    SSLSessionCacheTimeout 300

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingCache shmcb:/var/run/ocsp(128000)

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"

    # Document Root
    DocumentRoot /var/www/qpay/public
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/qpay-error.log
    CustomLog ${APACHE_LOG_DIR}/qpay-access.log combined

    # Gzip compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/x-httpd-php
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>

    # Cache headers untuk static files
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|webp)$">
        Header set Cache-Control "max-age=31536000, public"
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
    </FilesMatch>

    # Laravel Directory Configuration
    <Directory /var/www/qpay/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted

        # Laravel rewrite rules
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # Handle Authorization Header
            RewriteCond %{HTTP:Authorization} ^(.*)$
            RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]
            
            # Redirect Trailing Slashes If Not A Folder
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_URI} (.+)/$
            RewriteRule ^ %1 [L,R=301]
            
            # Handle Front Controller
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^ index.php [L]
        </IfModule>
    </Directory>

    # Block sensitive files
    <FilesMatch "^(.env|.env.*|.git|.gitignore|.htaccess|composer.json|composer.lock)">
        <IfModule mod_authz_core.c>
            Require all denied
        </IfModule>
        <IfModule !mod_authz_core.c>
            Order allow,deny
            Deny from all
        </IfModule>
    </FilesMatch>

    # Block directories
    <DirectoryMatch "^/var/www/qpay/(config|app|bootstrap|storage|routes|database|tests|vendor)">
        <IfModule mod_authz_core.c>
            Require all denied
        </IfModule>
        <IfModule !mod_authz_core.c>
            Order allow,deny
            Deny from all
        </IfModule>
    </DirectoryMatch>
</VirtualHost>
